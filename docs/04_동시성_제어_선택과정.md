# 이커머스 시나리오 동시성 이슈 발생 유형
## 1. 잔액 변동
### 1-1. 설명
- 잔액은 사용자 개인이 보유한 정보로, 다른 사용자와 동일 자원을 공유하지 않는다. 동일 사용자가 여러 작업을 동시 요청할 수도 있지만, 여러 사용자가 동시 요청하는 것에 비하면 충돌 가능성이 작다.
- 결국 잔액 변동 시 일어나는 동시성 문제는 사용자가 짧은 시간에 더블 클릭과 같이 여러 번의 요청을 동시에 보내는 경우밖에 없다.
### 1-2. 해결책 : 낙관적 락
- 구현이 간단하고 자원 소비가 적고, 데이터베이스에 과도한 부하를 주지 않으므로 효율적이다.

## 2. 선착순 쿠폰 발급 & 상품 재고 갱신 (주문의 재고 차감, 결제 실패 시 복원)
### 2-1. 설명
- 선착순 쿠폰과 상품 재고 갱신은 잔액 변동과는 달리 다수의 사용자로부터 동일 자원에 대한 요청을 처리한다. 그러므로 충돌 가능성이 더 높다.
### 2-2. (예상) 해결책 : Redis 분산 락
- Redis는 인메모리 데이터베이스이므로 속도가 매우 빨라 실시간 동시성 제어에 용이하다. 또한 다수의 인스턴스에서 일어나는 동시성 문제 해결에 적합하다.

### 2-3. 예상
- 분산 락을 사용하는 전제는 속도면에서 우위에 있을 거라는 예상에 있다.
- 선착순 쿠폰 발급에서 비관적 락과 분산 락을 이용하여 비교하였다. 원래 기대했던 바는 비관적 락보다 분산 락이 더 빠른 거였다.

![image](https://github.com/user-attachments/assets/b9a4fc11-d8a0-4967-aa84-9b38881e8b10)

- 그러나 비관적 락이 분산 락보다 훨씬 빠르다. 어떻게 된 걸까?

### 2-4. 분산 락이 비관적 락보다 느린 이유
- Redis 분산 락이 무조건 빠를 거란 기대는 착각에서 비롯되었다. Redis 분산 락은 네트워크 통신이 필요하고, 락 획득과 해제 과정에서 오버헤드가 발생할 수 있다. 각 서버 간의 네트워크 지연이 발생하고, 분산 락을 관리하는 데 있어 Redis 서버의 부하가 있을 수 있다.
- 반면, 비관적 락은 데이터베이스 내에서 바로 락을 걸고 처리하기 때문에, 네트워크 오버헤드가 없고 데이터베이스에서 직접 처리되므로 더 빠를 수 있다.
- 그러나 비동기 처리와 병렬화가 가능한 상황에서는 분산 락이 더 효율적이다. 고성능 클러스터 환경에서 Redis의 빠른 속도와 다중 서버에서 동시 작업을 처리할 수 있다.

### 2-5. 분산 락의 단점
- Redis는 메모리 기반 저장소로 데이터를 저장할 때 휘발성이기 때문에 Redis 장애 발생 시 데이터 정합성이 발생한다. `Redlock` 알고리즘으로 다중 노드에 락을 저장하여 복구 상황에서도 락 상태를 유지하려고 시도할 수 있지만, 완벽한 정합성을 보장하지는 않는다.

### 2-6. 결론
- 속도와 실시간 처리가 중요하다면 Redis 분산 락, 데이터 일관성이 중요하다면 비관적 락을 사용함이 좋다.
- 원래는 분산 락을 사용하면 무조건 성능이 좋다고 생각하여 선착순 쿠폰과 재고 변동 모두 분산 락을 고려했다. 그러나 실제 테스트 결과, 분산 락은 네트워크 통신과 락 관리로 인한 오버헤드가 발생해 재고 변동처럼 데이터 정합성이 중요한 작업에서는 비관적 락보다 성능이 떨어지는 것으로 보인다. 이를 통해 작업의 특성에 따라 적절한 락을 선택하는 것이 중요하다는 결론에 도달했다.
- 선착순 쿠폰은 속도가 생명이므로 분산 락을 채택하고, 재고 변동은 데이터 정합성이 중요하므로 비관적 락을 채택했다.
- 이 결론에는 아직 의문이 많다. 이러한 판단이 적절한지 좀더 검토하고 반영할 필요성이 존재한다.

## 3. 참고 링크
- [풀필먼트 입고 서비스팀에서 분산락을 사용하는 방법 - Spring Redisson](https://helloworld.kurly.com/blog/distributed-redisson-lock/)
- [Redis를 이용한 분산 락 구현의 성능 관련 질문](https://www.inflearn.com/community/questions/889653/redis-%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%B6%84%EC%82%B0-%EB%9D%BD-%EA%B5%AC%ED%98%84%EC%9D%98-%EC%84%B1%EB%8A%A5-%EA%B4%80%EB%A0%A8-%EC%A7%88%EB%AC%B8?srsltid=AfmBOopYDBlH8tH-oZiiZcuLZ4CjcdGaFSQA_g4MWmrMPUpL3aIp5wj2)
- [레디스가 제공하는 분산락의 특징](https://mangkyu.tistory.com/311)
